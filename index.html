<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emily ‚Äî Unsere Zeitleiste</title>
  <meta name="theme-color" content="#0b0b10" />

  <style>
    :root{
      --bg0:#07080c;
      --bg1:#0a0b12;
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.62);
      --stroke: rgba(255,255,255,.12);
      --glass: rgba(255,255,255,.06);
      --shadow: 0 28px 80px rgba(0,0,0,.55);
      --radius: 26px;
      --max: 1120px;

      --a1:#7dd3fc;
      --a2:#a78bfa;
      --a3:#fb7185;

      --heart:#fb7185;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 70% -10%, rgba(125,211,252,.10), transparent 60%),
        radial-gradient(900px 600px at 10% 18%, rgba(251,113,133,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
	body::after{
	  content:"";
	  position: fixed;
	  inset: 0;
	  z-index: -1;
	  pointer-events: none;

	  background:
	    radial-gradient(1200px 800px at 20% 10%, var(--g1, rgba(125,211,252,.10)), transparent 60%),
	    radial-gradient(1200px 800px at 85% 30%, var(--g2, rgba(167,139,250,.10)), transparent 62%),
	    radial-gradient(1000px 700px at 45% 110%, var(--g3, rgba(251,113,133,.08)), transparent 65%),
	    linear-gradient(180deg, var(--bg0), var(--bg1));

	  transition: background 220ms linear;
	  opacity: 1;
	}

    /* Top progress bar */
    .progress{
      position:fixed; top:0; left:0; right:0;
      height:3px; z-index:9999;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    .progress > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.16), var(--a1), var(--heart));
      box-shadow: 0 0 18px color-mix(in srgb, var(--a1) 28%, transparent);
      transform-origin: 0 50%;
    }
	.progressDate{
	  position: fixed;
	  top: 10px;                 /* unter dem 3px Balken */
	  left: 16px;                /* wird von JS √ºberschrieben */
	  z-index: 9999;
	  padding: 6px 10px;
	  border-radius: 999px;
	  border: 1px solid rgba(255,255,255,.14);
	  background: rgba(0,0,0,.28);
	  color: rgba(255,255,255,.85);
	  font-size: 12px;
	  letter-spacing: .08em;
	  text-transform: uppercase;
	  backdrop-filter: blur(10px);
	  pointer-events: none;

	  transform: translateX(-50%);
	  transition: left 120ms linear, opacity 200ms ease;
	  opacity: .95;
	}

    header{
      padding: 86px 20px 34px;
    }
    .wrap{ max-width: var(--max); margin: 0 auto; }
    .kicker{
      color: var(--muted);
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .kicker .miniHeart{
      width:8px; height:8px; border-radius:50%;
      background: var(--heart);
      box-shadow: 0 0 16px color-mix(in srgb, var(--heart) 45%, transparent);
    }
    h1{
      margin: 12px 0 0;
      font-weight: 650;
      font-size: clamp(34px, 5vw, 62px);
      line-height: 1.05;
      letter-spacing: -0.02em;
    }
    .sub{
      margin-top: 14px;
      color: var(--muted);
      font-size: 16px;
      max-width: 70ch;
      line-height: 1.65;
    }
    .hint{
      margin-top: 18px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
    }

    main{ padding-bottom: 110px; }

    /* Chapters: runway is variable now */
    .chapter{
      position: relative;
      height: var(--h, 360vh);     /* default fallback, overridden per chapter */
      padding: 0 20px;
      --p: 0;
      --tint1: color-mix(in srgb, var(--a1) 12%, transparent);
      --tint2: color-mix(in srgb, var(--a2) 10%, transparent);
      --tint3: color-mix(in srgb, var(--heart) 8%, transparent);
    }
    .chapter::before{
      content:"";
      position:absolute;
      inset:-140px -80px;
      background:
        radial-gradient(1100px 760px at 12% 16%, var(--tint1), transparent 60%),
        radial-gradient(1100px 760px at 88% 34%, var(--tint2), transparent 62%),
        radial-gradient(900px 640px at 45% 110%, var(--tint3), transparent 62%);
		opacity: calc(
		  0.10 + (1 - (var(--p) - 0.5) * (var(--p) - 0.5) * 4) * 0.85
		);
      pointer-events:none;
    }

    .sticky{
      position: sticky;
      top: 56px;                  /* minimal mehr Ruhe auf Handy */
      height: calc(100vh - 92px);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .panel{
      width: min(var(--max), 100%);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.045);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(16px);

      display:grid;
      grid-template-columns: 1.12fr .88fr;
      min-height: 70vh;
    }

    /* TEXT-ONLY MODE */
    .panel.noMedia{
      grid-template-columns: 1fr !important;
    }
    .panel.noMedia .media{
      display:none;
    }

    /* Media side */
    .media{
      position: relative;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,.07), transparent 58%),
        radial-gradient(900px 600px at 80% 30%, rgba(255,255,255,.05), transparent 60%),
        rgba(0,0,0,.25);
      border-right: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .media::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1000px 650px at 10% 0%, color-mix(in srgb, var(--a1) 22%, transparent), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, color-mix(in srgb, var(--a2) 18%, transparent), transparent 60%);
      opacity:.80;
      pointer-events:none;
    }
    .mediaInner{
      position:absolute; inset:0;
      padding: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .frame{
      width: 100%;
      height: 100%;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      position: relative;

      transform: scale(calc(.995 + var(--p) * .005));
      opacity: calc(.78 + var(--p) * .22);
      filter: blur(calc(clamp(0, (0.40 - var(--p)) / 0.40, 1) * 6px));
    }
    img.heroImg, video.heroVid{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(calc(1.03 + (1 - var(--p)) * .03));
      filter: saturate(1.05) contrast(1.03);
    }

    .glint{
      position:absolute;
      top: 14px; right: 14px;
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 26px color-mix(in srgb, var(--heart) 22%, transparent);
      opacity: calc(.15 + var(--p) * .85);
      transform: translateY(calc((1 - var(--p)) * -8px)) scale(calc(.92 + var(--p) * .08));
      user-select:none;
    }
    .glint span{
      font-size: 14px;
      color: color-mix(in srgb, var(--heart) 85%, white);
    }

    /* Copy side */
    .copy{
      padding: 30px 28px;
      position: relative;
    }
    .dateRow{
      display:flex; align-items:center; gap:10px;
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(255,255,255,.62);
    }
    .dot{
      width: 8px; height:8px; border-radius:50%;
      background: var(--a1);
      box-shadow: 0 0 16px color-mix(in srgb, var(--a1) 45%, transparent);
    }
    .title{
      margin: 14px 0 0;
      font-size: 32px;
      line-height: 1.12;
      font-weight: 650;
      letter-spacing: -0.02em;
    }
    .text{
      margin: 14px 0 0;
      color: rgba(255,255,255,.74);
      font-size: 15px;
      line-height: 1.75;
      max-width: 62ch;
    }
    .detail{
      margin-top: 16px;
      color: rgba(255,255,255,.68);
      font-size: 13px;
      line-height: 1.7;
      max-width: 64ch;
    }
    .badgeRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 18px;
    }
    .badge{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
    }

    /* 3-phase choreography controlled by CSS vars from JS */
    .phase1, .phase2, .phase3{
      will-change: opacity, transform, filter;
    }
    .phase1{ opacity: var(--ph1o); transform: translateY(var(--ph1y)); filter: blur(var(--ph1b)); }
    .phase2{ opacity: var(--ph2o); transform: translateY(var(--ph2y)); filter: blur(var(--ph2b)); }
    .phase3{ opacity: var(--ph3o); transform: translateY(var(--ph3y)); filter: blur(var(--ph3b)); }

    /* Footer */
    .end{
      padding: 80px 20px 110px;
      text-align:center;
      color: rgba(255,255,255,.70);
    }
    .cta{
      display:inline-flex; gap:10px; align-items:center;
      margin-top: 18px;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      text-decoration:none;
      backdrop-filter: blur(10px);
    }
	/* Finale: nur Text, gro√ü & mittig */
	.finale .panel{
	  grid-template-columns: 1fr !important;
	  min-height: 60vh;
	}
	.finale .media{ display:none !important; }

	.finale .copy{
	  display:flex;
	  flex-direction:column;
	  align-items:center;
	  justify-content:center;
	  text-align:center;
	  padding: 56px 28px;
	}

	.finale .dateRow{ display:none; }

	.finale .title{
	  font-size: clamp(40px, 6vw, 76px);
	  line-height: 1.05;
	  max-width: 18ch;
	}

	.finale .text{
	  font-size: clamp(16px, 2.2vw, 22px);
	  line-height: 1.6;
	  color: rgba(255,255,255,.78);
	  max-width: 46ch;
	}

	.finale .detail, .finale .badgeRow{ display:none !important; }

    /* Mobile */
	@media (max-width: 980px){

	  /* Sticky-Viewport stabiler auf iOS */
	  .sticky{
	    top: 46px;
	    height: calc(100svh - 92px);
	  }

	  /* Panel muss eine echte H√∂he bekommen, sonst kann Media nicht wachsen */
	  .panel{
	    grid-template-columns: 1fr;
	    height: 100%;              /* <- WICHTIG */
	    min-height: 0;             /* <- WICHTIG (sonst blockt grid) */
	  }

	  /* Media bekommt echte H√∂he: wird sichtbar gro√ü */
	  .media{
	    height: 58%;               /* <- stell hier ein: 50%..65% */
	    min-height: 360px;         /* <- stell hier ein */
	    border-right: 0;
	    border-bottom: 1px solid rgba(255,255,255,.10);
	  }

	  /* Copy nimmt den Rest */
	  .copy{
	    height: 42%;
	    padding: 18px 16px;
	    overflow: auto;            /* <- wichtig: Text bleibt lesbar */
	    -webkit-overflow-scrolling: touch;
	  }

	  /* Media ohne unn√∂tige R√§nder -> wirkt gr√∂√üer */
	  .mediaInner{ padding: 10px; }

	  /* Frame full height */
	  .frame{
	    height: 100%;
	    border-radius: 18px;       /* oder 0 wenn du full-bleed willst */
	  }
	}

    @media (prefers-reduced-motion: reduce){
      .chapter{ height:auto; }
      .sticky{ position:static; height:auto; }
      .frame{ transform:none; filter:none; opacity:1; }
      .progress{ display:none; }
    }
  </style>
</head>

<body>
  <div class="progress" aria-hidden="true"><div id="pbar"></div></div>
  <div class="progressDate" id="pdate">‚Äî</div>

  <header>
    <div class="wrap">
      <div class="kicker"><span class="miniHeart"></span><span>Valentinstag</span></div>
      <h1>Emily, das ist unsere Story.</h1>
      <p class="sub">
        Eine Timeline, die unsere Geschichte erz√§hlt.
      </p>
      <div class="hint">
        <div class="pill">Ein Denkmal unserer Liebe</div>
        <div class="pill">Mit den sch√∂nsten Erinnerungen</div>
        <div class="pill">Von uns beiden</div>
      </div>
    </div>
  </header>

  <main id="main"></main>

  <section class="end">
    <div class="wrap">
      <h2 style="margin:0; font-size:28px; letter-spacing:-0.01em;">Und das Beste kommt noch.</h2>
      <div style="margin-top:10px; color: rgba(255,255,255,.62); line-height:1.7;">
        Wenn du willst, schick mir einfach ein ‚ù§Ô∏è zur√ºck.
      </div>
	  <a class="cta"
	     href="mailto:alierentrms@gmail.com?subject=‚ù§Ô∏è&body=Hey%20Eren%2C%0A%0A‚ù§Ô∏è%0AEmily">
	    ‚úâÔ∏è Antwort schreiben
	  </a>
    </div>
  </section>

  <script>
    // =========================
    // 1) HIER DEINE KAPITEL
    // =========================
    // Text-only: media: null  (oder media weglassen)
    // Media: { type:"image", src:"img/01.jpg" } oder { type:"video", src:"vid/01.mp4" }
    const slides = [
      {
        date: "28.11.2025",
        title: "Ein Tag, der mein Leben ver√§nderte.",
        text: "Eine Nachricht hat gereicht, um mir zu zeigen, dass wir auf dem selben Vibe sind.",
        details: "Ich wei√ü noch genau, wie ich l√§chelnd mit dir geschrieben hab",
        badges: null,
        accents: ["#7dd3fc", "#a78bfa", "#fb7185"],
        media: null
      },
      {
        date: "29.11.2025",
        title: "Unser erstes Date.",
        text: "Wir beide waren sehr nerv√∂s, obwohl sich herausgestellt hat...",
        details: "... dass wir f√ºreinander bestimmt waren.",
        badges: null,
        accents: ["#fb7185", "#60a5fa", "#a78bfa"],
		media: { type:"image", src:"bey.jpg" }
      },
      {
        date: "07.12.2025",
        title: "Der Tag, an dem ich mein Sinn des Lebens entdeckt hab.",
        text: "Wir waren auf der Hardt...",
        details: "... als sich unsere Lippen das erste Mal ber√ºhrten.",
        badges: ["üíã Unser erster Kuss", "üåô Stimmung"],
        accents: ["#34d399", "#22d3ee", "#fb7185"],
        media: { type:"image", src:"" }
      },
      {
        date: "23.12.2025",
        title: "Ein Geschenk, welches ich nie vergessen werde...",
        text: "Es mag unrelevant wirken...",
        details: "... aber f√ºr mich hat es die Welt bedeutet.",
        badges: ["üíÖüèº E"],
        accents: ["#fb7185", "#60a5fa", "#a78bfa"],
        media: { type:"image", src:"n.jpg" }
      },
      {
        date: "27.12.2025",
        title: "Der kleine Engel am Schlafen.",
        text: "Du bist eingeschlafen",
        details: "Und ich hab die Chance genutzt.",
        badges: ["üåô Stimmung"],
        accents: ["#34d399", "#22d3ee", "#fb7185"],
        media: { type:"video", src:"schlafi.mp4" }
      },
      {
        date: "29.12.2025",
        title: "Frau am Steuer...",
        text: "... Das wird teuer!",
        details: "Ampeln sind nur ein Vorschlag",
        badges: ["üöó"],
        accents: ["#fb7145", "#60a5fa", "#a78bfa"],
        media: { type:"image", src:"auto.jpg" }
      },
      {
        date: "01.01.2026",
        title: "Frohes Neues Jahr üéÜ",
        text: "Wir haben das Jahr zusammen gestartet...",
        details: "... und werden es zusammen beenden!",
        badges: ["üéÜ"],
        accents: ["#fb7185", "#60a3fa", "#a78bfa"],
        media: { type:"video", src:"n1.mp4" }
      },
      {
        date: "02.01.2026",
        title: "Der Tag, der mich zum gl√ºcklichsten Mann der Welt machte.",
        text: "Ein Tag nach Neujahr haben wir unsere Liebe gestanden...",
        details: "... und nichts f√§llt mir leichter als dich zu lieben!",
        badges: ["‚ù§Ô∏è", "üíã"],
        accents: ["#fb7185", "#60a3fa", "#a78bfa"],
        media: null
      },
      {
        date: "20.01.2026",
        title: "Ein Bild, was ich Mama zeigen kann.",
        text: "H√§tte niemals gedacht, dass Bilder machen so schwer sein kann",
        details: null,
        badges: ["üì∏ Say Cheese!"],
        accents: ["#fb7185", "#60a3fa", "#a78bfa"],
		media: { type:"image", src:"mama.jpg" }
      },
	  {
	    date: "",
	    title: "Und jetzt sind wir unzertrennlich! ‚ù§Ô∏è",
	    text: "Ich liebe dich √ºber alles, mein Babygirl ‚ù§Ô∏è",
	    details: null,
	    badges: null,
	    accents: ["#fb7185", "#a78bfa", "#7dd3fc"],
	    media: null,
	    finale: true
	  }
    ];

    // =========================
    // 2) BUILD DOM + dynamic runway
    // =========================
    const main = document.getElementById("main");

    slides.forEach((s, idx) => {
      const ch = document.createElement("section");
      ch.className = "chapter";
	  if (s.finale) ch.classList.add("finale");
      ch.dataset.index = idx;

      const [a1,a2,a3] = s.accents || ["#7dd3fc","#a78bfa","#fb7185"];
      ch.style.setProperty("--a1", a1);
      ch.style.setProperty("--a2", a2);
      ch.style.setProperty("--a3", a3);
      ch.style.setProperty("--tint1", hexToRGBA(a1, .12));
      ch.style.setProperty("--tint2", hexToRGBA(a2, .10));
      ch.style.setProperty("--tint3", hexToRGBA(a3, .08));

      // dynamic runway so details are readable
      const hasMedia = !!(s.media && s.media.src);
      const hasDetails = !!(s.details && String(s.details).trim().length);
      const badgeCount = (s.badges || []).length;

	  let h = 420;
	  if (hasMedia)   h += 180;   // vorher 60
	  if (hasDetails) h += 220;   // vorher 80/160
	  if (badgeCount) h += 80;    // vorher 40
	  if (!hasMedia)  h += 120;   // text-only braucht auch runway
	  if (s.finale) h = 700;
	  h = Math.max(420, Math.min(900, h));
	  ch.style.setProperty("--h", `${h}vh`);

      const sticky = document.createElement("div");
      sticky.className = "sticky";

      const panel = document.createElement("div");
      panel.className = "panel" + (hasMedia ? "" : " noMedia");
	  if (s.finale) panel.classList.add("finalePanel");

      // MEDIA (only if hasMedia)
      if (hasMedia) {
        const media = document.createElement("div");
        media.className = "media";

        const inner = document.createElement("div");
        inner.className = "mediaInner";

        const frame = document.createElement("div");
        frame.className = "frame";

        const glint = document.createElement("div");
        glint.className = "glint";
        glint.innerHTML = `<span>‚ù§</span>`;
        frame.appendChild(glint);

		if (s.media.type === "video") {
		  const v = document.createElement("video");
		  v.className = "heroVid";
		  v.src = s.media.src;

		  // iOS/Safari: als ATTRIBUTE setzen
		  v.muted = true;
		  v.defaultMuted = true;
		  v.playsInline = true;
		  v.loop = true;
		  v.autoplay = true;
		  v.preload = "auto";

		  v.setAttribute("muted", "");
		  v.setAttribute("playsinline", "");
		  v.setAttribute("autoplay", "");

		  // Debug (optional, aber hilfreich)
		  v.addEventListener("error", () => console.log("VIDEO ERROR", v.currentSrc, v.error));
		  v.addEventListener("loadedmetadata", () => console.log("METADATA OK", v.currentSrc, "dur:", v.duration));
		  v.addEventListener("canplay", () => console.log("CANPLAY", v.currentSrc));

		  frame.appendChild(v);
		} else {
          const img = document.createElement("img");
          img.className = "heroImg";
          img.alt = "";
          img.loading = "lazy";
          img.src = s.media.src;
          frame.appendChild(img);
        }

        inner.appendChild(frame);
        media.appendChild(inner);
        panel.appendChild(media);
      }

      // COPY (3 phases)
      const copy = document.createElement("div");
      copy.className = "copy";
      copy.innerHTML = `
        <div class="dateRow phase1"><span class="dot" style="background:${a1}"></span><span>${esc(s.date)}</span></div>
        <div class="title phase1">${esc(s.title)}</div>

        <div class="text phase2">${esc(s.text)}</div>

        ${s.details ? `<div class="detail phase3">${esc(s.details)}</div>` : ``}

        ${(s.badges && s.badges.length)
          ? `<div class="badgeRow phase3">${s.badges.map(b => `<div class="badge">${esc(b)}</div>`).join("")}</div>`
          : ``}
      `;
      panel.appendChild(copy);

      sticky.appendChild(panel);
      ch.appendChild(sticky);
      main.appendChild(ch);
    });
	// ===== iOS/Safari: Video playback einmal "freischalten" (nach erster User-Geste) =====
	function unlockVideosOnce(){
	  document.removeEventListener("touchstart", unlockVideosOnce);
	  document.removeEventListener("click", unlockVideosOnce);

	  window.__videoUnlocked = true;
	}
	document.addEventListener("touchstart", unlockVideosOnce, { once:true });
	document.addEventListener("click", unlockVideosOnce, { once:true });

	document.addEventListener("touchstart", unlockVideosOnce, { once:true, passive:true });
	document.addEventListener("click", unlockVideosOnce, { once:true });

    // =========================
    // 3) Scroll Scrub Engine (details earlier + longer)
    // =========================
    const chapters = Array.from(document.querySelectorAll(".chapter"));
    const pbar = document.getElementById("pbar");
	const pdate = document.getElementById("pdate");

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function smoothstep(a,b,x){
      const t = clamp01((x - a) / (b - a));
      return t * t * (3 - 2*t);
    }

    function setPhaseVars(ch, p){
      // Phase 1 early, Phase 2 mid, Phase 3 earlier than before (for readability)
      const ph1 = smoothstep(0.05, 0.38, p);
      const ph2 = smoothstep(0.20, 0.70, p);
      const ph3 = smoothstep(0.30, 0.70, p); // <-- earlier start, long hold

      ch.style.setProperty("--ph1o", (0.12 + 0.88*ph1).toFixed(4));
      ch.style.setProperty("--ph1y", `${((1 - ph1)*18).toFixed(2)}px`);
      ch.style.setProperty("--ph1b", `${((1 - ph1)*7).toFixed(2)}px`);

      ch.style.setProperty("--ph2o", (0.08 + 0.92*ph2).toFixed(4));
      ch.style.setProperty("--ph2y", `${((1 - ph2)*22).toFixed(2)}px`);
      ch.style.setProperty("--ph2b", `${((1 - ph2)*7).toFixed(2)}px`);

	  ch.style.setProperty("--ph3o", (0.25 + 0.75*ph3).toFixed(4));
	  ch.style.setProperty("--ph3y", `${((1 - ph3)*10).toFixed(2)}px`);
      ch.style.setProperty("--ph3b", `${((1 - ph3)*7).toFixed(2)}px`);
    }
	function getActiveChapterIndex(){
	  const vh = window.innerHeight;
	  let best = 0;
	  let bestDist = Infinity;

	  chapters.forEach((ch, i) => {
	    const r = ch.getBoundingClientRect();
	    const center = r.top + r.height / 2;
	    const dist = Math.abs(center - vh * 0.52); // N√§he zur Bildschirmmitte
	    if (dist < bestDist) { bestDist = dist; best = i; }
	  });

	  return best;
	}

    function update(){
      const doc = document.documentElement;
      const scrollTop = doc.scrollTop || document.body.scrollTop;
      const scrollHeight = doc.scrollHeight - doc.clientHeight;
      const gp = scrollHeight > 0 ? (scrollTop / scrollHeight) : 0;
      pbar.style.width = (gp * 100).toFixed(2) + "%";
	  // ===== Global Background: Farben √ºber Scroll progressiv mischen =====
	  const i = getActiveChapterIndex();                 // hast du ja schon f√ºr Datum
	  const cur = slides[i] || slides[0];
	  const nxt = slides[Math.min(i+1, slides.length-1)] || cur;

	  // Wie weit du im aktuellen Kapitel bist (0..1) ‚Äì du speicherst p ja in dataset.pp
	  const pLocal = parseFloat(chapters[i].dataset.pp || "0");

	  // Mix beginnt ab Mitte und zieht bis Ende durch (damit‚Äôs nicht zu fr√ºh springt)
	  const tMix = clamp01((pLocal - 0.55) / 0.55);

	  const cA = cur.accents || ["#7dd3fc","#a78bfa","#fb7185"];
	  const cB = nxt.accents || cA;

	  // leichte Variation mit globalem Fortschritt (damit es nicht repetitiv wirkt)
	  const wobble = (Math.sin(gp * Math.PI * 6) + 1) * 0.5; // 0..1
	  const alpha1 = 0.16 + wobble * 0.06;
	  const alpha2 = 0.14 + (1-wobble) * 0.06;
	  const alpha3 = 0.12 + wobble * 0.05;

	  document.documentElement.style.setProperty("--g1", mixHex(cA[0], cB[0], tMix, alpha1));
	  document.documentElement.style.setProperty("--g2", mixHex(cA[1], cB[1], tMix, alpha2));
	  document.documentElement.style.setProperty("--g3", mixHex(cA[2], cB[2], tMix, alpha3));
	  // ===== Datum-Pille: Text + Position (wandert mit globalem Progress) =====
	  if (pdate) {
	    const idx = getActiveChapterIndex();
	    const d = (slides[idx] && slides[idx].date) ? slides[idx].date : "‚Äî";
	    pdate.textContent = d;

	    // Position entlang der Bildschirmbreite (mit Clamping)
	    const w = window.innerWidth;
	    const pad = 18; // Abstand zu R√§ndern
	    const x = pad + gp * (w - pad * 2);

	    pdate.style.left = `${x}px`;
	  }

      const vh = window.innerHeight;
      chapters.forEach(ch => {
        const r = ch.getBoundingClientRect();
        const total = r.height;

		// Progress im Kapitel: mit HOLD-Zone (mehr Lesezeit)
		const enter = vh * 0.85;
		const leave = -vh * 0.15;

		const t = (enter - r.top) / (r.height + (enter - leave));
		const p0 = clamp01(t);

		// optional: erst hold oder linear, dann gl√§tten
		const target = p0; // <- oder smoothHold(...) wenn du willst

		const prev = parseFloat(ch.dataset.pp || "0");
		const p = prev + (target - prev) * 0.12; // 0.08..0.18 je nach Geschmack
		ch.dataset.pp = p;

		ch.style.setProperty("--p", p.toFixed(4));
		setPhaseVars(ch, p);
      });
    }

	let ticking = false;
	window.addEventListener("scroll", () => {
	  if (!ticking) {
	    requestAnimationFrame(() => { update(); ticking = false; });
	    ticking = true;
	  }
	}, { passive: true });
	update();
	window.addEventListener("resize", update);

    // =========================
    // 4) Videos: play only when visible
    // =========================
	const vidObserver = new IntersectionObserver((entries) => {
	  entries.forEach(entry => {
	    const v = entry.target.querySelector("video");
	    if (!v) return;

	    if (entry.isIntersecting) {
	      if (window.__videoUnlocked) v.play().catch(()=>{});
	    } else {
	      if (!v.paused) v.pause();
	    }
	  });
	}, { threshold: 0.10, rootMargin: "0px 0px -35% 0px" });

	document.querySelectorAll(".chapter").forEach(ch => vidObserver.observe(ch));

    // =========================
    // Helpers
    // =========================
    function esc(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
	function smoothstep01(t){
	  t = Math.max(0, Math.min(1, t));
	  return t * t * (3 - 2*t);
	}

	function smoothHold(x, holdStart = 0.30, holdEnd = 0.85, strength = 0.55){
	  // x: 0..1
	  // holdStart/holdEnd: Bereich, in dem gebremst wird
	  // strength: 0..0.85 (wie stark gebremst wird) ‚Äî 0.55 ist gut

	  x = Math.max(0, Math.min(1, x));

	  // s=0 vor holdStart, s=1 nach holdEnd (weich)
	  const s = smoothstep01((x - holdStart) / (holdEnd - holdStart));

	  // Je n√§her s an 1, desto st√§rker verlangsamen wir
	  // Das hier ist eine glatte Mischung aus "normal" (x) und "gebremst" (x*(1-strength))
	  const slow = x * (1 - strength);

	  // Blend: am Anfang fast x, in der Mitte mehr slow, am Ende wieder n√§her an x
	  // Trick: wir machen die Bremse in der Mitte am st√§rksten (bell-shape)
	  const bell = s * (1 - s) * 4; // 0..1..0
	  return x - (x - slow) * bell;
	}
    function hexToRGBA(hex, a){
      const h = String(hex).replace("#","").trim();
      if (h.length !== 6) return `rgba(255,255,255,${a})`;
      const r = parseInt(h.slice(0,2),16);
      const g = parseInt(h.slice(2,4),16);
      const b = parseInt(h.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }
	function hexToRgb(hex){
	  const h = String(hex).replace("#","").trim();
	  if (h.length !== 6) return {r:255,g:255,b:255};
	  return {
	    r: parseInt(h.slice(0,2),16),
	    g: parseInt(h.slice(2,4),16),
	    b: parseInt(h.slice(4,6),16),
	  };
	}

	function lerp(a,b,t){ return a + (b-a)*t; }

	function mixHex(a,b,t,alpha=0.12){
	  const A = hexToRgb(a), B = hexToRgb(b);
	  const r = Math.round(lerp(A.r,B.r,t));
	  const g = Math.round(lerp(A.g,B.g,t));
	  const b2 = Math.round(lerp(A.b,B.b,t));
	  return `rgba(${r},${g},${b2},${alpha})`;
	}
  </script>
</body>
</html>